<!DOCTYPE html>
<html lang="ru-RU">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta property="og:title" content="SP Online: Debug Remote Event Receivers &#43; ngrok &middot; .ash ">
        <meta property="og:site_name" content=".ash"/>
        <meta property="og:description" content="">
        <meta property="og:url" content="http://ashblog.ru/sp/debug-remote-event-receivers/" />
        <meta property="og:locale" content="ru-RU">
        <meta name="author" content="alexander">
        <meta name="description" content="">
        <meta name="keywords" content="">
        <meta name="generator" content="Hugo 0.16" />
        <link rel="icon" href="http://ashblog.ru/assets/favicon.ico" type="image/x-icon"> 
        <link rel="stylesheet" href="http://ashblog.ru/css/slender-base.css">
        <link rel="stylesheet" href="http://ashblog.ru/css/slender-color-schemes.css">
        <link rel="stylesheet" href="http://ashblog.ru/css/font-awesome-4.5.0.min.css">
        <link rel="stylesheet" href="http://ashblog.ru/css/highlight-9.0.0-default.min.css">
        <title>
            
                sp online: debug remote event receivers &#43; ngrok &middot; .ash
            
        </title>
    </head>
    <body class="color-scheme-white">
        <div class="container">
            <header>
                <nav>
                    <ul><li><a href="http://ashblog.ru/">.дом</a></li><li><a href="http://ashblog.ru/sp/">.sp</a></li><li><a href="http://ashblog.ru/about/">.я</a></li></ul>
                </nav>
                
                    <div style="background-color:pink;width:200px;margin: 0 auto;">
                    <h1 class="brand"><a style="text-decoration:none;" 
                            href="http://ashblog.ru/">.ash</a></h1>
                       </div>
                    <aside>
                        <p>SP Online: Debug Remote Event Receivers &#43; ngrok</p>
                    </aside>
                
            </header>
<article class="article-content">
    

<p>Обычно отладка Remote Event Receivers в SharePoint Online выполняется с помощью Service Bus.
Я писал подробно про это <a href="http://blog.virtosoftware.com/2014/12/creating-and-debugging-of-remote-event.html">здесь</a> и <a href="http://blog.virtosoftware.com/2015/01/adding-remote-event-receivers-to-list.html">здесь</a>.
Сегодня мы рассмотрим другой (более простой) путь решения этой задачи.</p>

<p>Если коротко, то всё что нам нужно - это использовать <strong><a href="https://ngrok.com/">ngrok</a></strong><br />
На странице продукта коротко и ёмко описано его предназначение: ngrok - secure tunnels to localhost.</p>

<p>Первым делом качаем <a href="https://ngrok.com/download">ngrok</a><br />
Распаковываем архив в любую директорию.<br />
Открываем Visual Studio и создаём проект SharePoint Add-In (Provider-Hosted).<br />
Кликаем мышкой по имени add-in project (не web) -&gt; нажимем F4.<br />
Выбираем <strong>true</strong> для параметра <strong>Handle add-in installed</strong><br />

<figure >
    
        <img src="/images/spngrok-addin-installed-rer.png" />
    
    
    <figcaption>
        <h4>Handle add-in installed</h4>
        
    </figcaption>
    
</figure>
</p>

<p>В результате предыдущего действия будет создан <strong>.svc</strong> сервис, который будет вызываться после того,
как наше решение будет установлено на портале.
Этот сервис является примером удалённого обработчика данных (Remote Event Receiver).</p>

<p>Если на данном этапе нажать F5, то мы получим предупреждение от Visual Studio, о том, мы мы не сможем
отлаживать Remote Event Receivers, т.к. для этого необходимо настроить Service Bus.<br />

<figure >
    
        <img src="/images/spngrok-addin-servicebus-msg.png" />
    
    
    <figcaption>
        <h4>Предупреждение: MS Service Bus Connection</h4>
        
    </figcaption>
    
</figure>
</p>

<p>В процессе отладки адресом нашего приложения будет localhost, который недоступен извне.
Именно поэтому в Visual Studio появилось сообщение о настройке Service Bus.</p>

<p>ngrok позволит решить нам эту проблему.<br />
Итак, открываем папку с <strong>ngrok.exe</strong> и запускаем команду<br />
<strong>ngrok http -host-header=&ldquo;localhost:[port]&rdquo; [port]</strong></p>

<h4 id="программу-ngrok-не-закрываем-туннель-работает-пока-работает-ngrok">Программу ngrok не закрываем (туннель работает, пока работает ngrok)</h4>


<figure >
    
        <img src="/images/ngrok-run.png" />
    
    
</figure>


<p><strong>[port]</strong> заменяем на порт, который используется IIS Express для доступа к нашем сайту на localhost.
Порт можно получить выбрав Web-проект и нажав F4.

<figure >
    
        <img src="/images/spngrok-addin-localhost-port.png" />
    
    
    <figcaption>
        <h4>Получаем порт от localhost (для http)</h4>
        
    </figcaption>
    
</figure>
</p>

<p>После запуска ngrok мы получили временный адрес, по которому можно обращаться извне к localhost.<br />
Нажимаем правой кнопкой мыши по web-проекту, выбираем <strong>Set as StartUp Project</strong>. Жмём <strong>F5</strong><br />

<figure >
    
        <img src="/images/set-as-startup-project.png" />
    
    
    <figcaption>
        <h4>Set as StartUp Project</h4>
        
    </figcaption>
    
</figure>
</p>

<p>Открываем любой браузер и вводим адрес туннеля (используем https, <a href="https://e1e1e1e1e.ngrok.io">https://e1e1e1e1e.ngrok.io</a>)
В результате получим окно вида:

<figure >
    
        <img src="/images/ngrok-access-ok.png" />
    
    
</figure>
</p>

<p>Отлично, наш компьютер доступен извне. Теперь любой желающий может получить доступ к нашему
сайту, зная ngrok-адрес. На картинке выше мы видим стандартное сообщение об ошибке, которое
появилось в SharePointContextFilter.</p>

<p>Попробуем запустить add-in в режиме отладки. Для этого вернём тип запуска проекта.<br />
Выбираем в Solution Explorer наше решение, клик правой кнопкой мыши, выбираем <strong>Set StartUp Projects&hellip;</strong><br />
Выбираем <strong>Multiple startup projects</strong>, нажимаем <strong>OK</strong></p>

<p>Теперь необходимо открыть и изменить файл <strong>AppManifest.xml</strong>, для того, чтобы сменить адрес, по которому будет происходить
обращение к нашему сервису. Выбираем файл в Solution Explorer -&gt; жмём F7.<br />
Заменяем значение элемента <strong>InstallEventEndpoint</strong> на ngrok-адрес туннеля.

<figure >
    
        <img src="/images/ngrok-rer-address.PNG" />
    
    
</figure>
</p>

<p>Открываем файл с кодом сервиса <strong>AppEventReceiver.svc.cs</strong>, ставим breakpoint в первойм строчке метода <strong>ProcessEvent</strong>
Запускаем отладку: <strong>F5</strong></p>

<p>&hellip;&hellip;ждём&hellip;&hellip;&hellip;&hellip;</p>

<p>Ура! Breakpoint сработал.<br />
Однако, если выполнить шаги дальше, то мы увидим, что <strong>clientContext</strong> равен <strong>null</strong>. Причина в том, что в
результате запуска в режиме отладки, Visual Studio прописывает localhost адрес в качестве remote endpoint
для нашего приложения.

<figure >
    
        <img src="/images/ngrok-endpoint-problem.png" />
    
    
    <figcaption>
        <h4>Почти получилось...</h4>
        
    </figcaption>
    
</figure>
</p>

<p>Для того, чтобы обойти эту проблему зарегистриуем наш add-in вручную.
Октроем страницу: [dev_site_url]/_layouts/appregnew.aspx,<br />
Где [dev_site_url] - адрес сайта, на котором будет тестироваться приложение<br />
(например: <a href="https://testportal.sharepoint.com/sites/dev/_layouts/appregnew.aspx">https://testportal.sharepoint.com/sites/dev/_layouts/appregnew.aspx</a>)<br />
Нажимаем Generate для создания Client ID и Client Secret. В качестве доменного App Domain и Redirect Url указываем адрес
полученный при запуске ngrok. После этого жмём кнопку Save и полученную информацию сохраняем куда-нибудь в текстовый файл
(чтобы не потерять Client Secret).</p>


<figure >
    
        <img src="/images/spngrok-reg-addin.png" />
    
    
</figure>


<p>Вернёмся в Visual Studio, выбираем web-проект, и устанавливаем для него <strong>Set as StartUp Project</strong>. Открываем файл web.config
и заменяем в appSettings ClientId и ClientSecret на сгенерированные значения.
Далее нажимаем правой кнопкой по add-in проекту и выбираем <strong>Publish&hellip;</strong>.<br />
В <strong>Current profile:</strong> выбираем <strong>New..</strong>. Затем <strong>Create new profile</strong>.
Вводим любое слово для Profile Name (например, spNgrokProfile). Нажимаем кнопку <strong>Next</strong>.
Далее вводим Client ID и Client Secret, полученные на странице <strong>appregnew.aspx</strong>.
И жмём кнопку <strong>Finish</strong>. После этого мы можем собрать add-in: нажимаем <strong>Package the add-in</strong></p>

<p>В открывшемся окне вводим https адрес ngrok-туннелля, и проверяем Client ID. Далее <strong>Finish</strong>.
После сборки add-in откроется папка с app-файлом. Далее открываем в браузере dev-сайт -&gt; Site Contents -&gt;
открываем библиотеку <strong>App Packages</strong>. Нажимаем кнопку Upload и загружаем app-файл.</p>


<figure >
    
        <img src="/images/spngrok-apppackages-lib.png" />
    
    
</figure>


<p>Возвращаемся в Visual Studio, нажимаем <strong>F5</strong> (не забываем проверить, что web-проект выбран в качестве StartUp Project).
Итак, к этому моменту у нас залит add-in в App Packages, запущен web-проект в режиме отладки,
запущен ngrok, и установлен breakpoint в Event Receiver (метод ProcessEvent).
Осталось установить Add-In и убедиться, что breakpoint сработает. Для на dev-сайте переходим в список
<strong>Apps in Testing</strong> -&gt; нажимаем на <strong>new app to deploy</strong> -&gt; в модальном окне выбираем package: spNgrok -&gt;
адрес (Deploy app to) не меняем -&gt; нажимаем <strong>Deploy</strong> -&gt; далее <strong>Trust It</strong>.</p>


<figure >
    
        <img src="/images/spngrok-deploy-addin.png" />
    
    
</figure>


<p>Вернёмся в <strong>Site Contents</strong> и увидим, что наше приложение устанавливается.
Установка может занять несколько минут (даже для пустого add-in, и ), поэтому не удивляемся,
что наш breakpoint ещё не сработал. Ждём&hellip;</p>


<figure >
    
        <img src="/images/spngrok-addin-install-inprogress.png" />
    
    
    <figcaption>
        <h4>In Progress</h4>
        
    </figcaption>
    
</figure>


<p>И вот спустя несколько минут срабатывает breakpoint:</p>


<figure >
    
        <img src="/images/spngrok-fire-breakpoint.png" />
    
    
    <figcaption>
        <h4>Breakpoint</h4>
        
    </figcaption>
    
</figure>


<p>Нажимаем <strong>F5</strong> для прололжения выполнения работы программы, и ловим исключение: <strong>AudienceUriValidationFailedException</strong></p>


<figure >
    
        <img src="/images/spngrok-audience-exception.png" />
    
    
    <figcaption>
        <h4>Audience Exception</h4>
        
    </figcaption>
    
</figure>


<p>В ошибке говорится, что-то про localhost. Ок. Для того, чтобы решить эту проблему нам необходимо выполнить
последний шаг. Открываем web.config нашего web-проекта и добавляем в <strong>appSettings</strong> следующую строчку:<br />
<strong><code>&lt;add key=&quot;HostedAppHostNameOverride&quot; value=&quot;e1e1e1e1e.ngrok.io;localhost&quot;/&gt;</code></strong>
(Замените <strong>e1e1e1e1e.ngrok.io</strong> на ваш адрес ngrok-туннеля без https префикса)<br />
При сохранении web.config, Visual Studio сообщит, что необходимо выйти из debug-режима. Нажимаем OK.
Снова нажимаем <strong>F5</strong>. Возвращаемся в Site Contents и видим, что при установке возникла ошибка:
<strong>Sorry, something went wrong with adding the app. Click to retry.</strong><br />
Нажимаем <strong>Click to retry</strong> и ждём срабатывание breakpoint.</p>


<figure >
    
        <img src="/images/spngrok-final-breakpoint-ok.png" />
    
    
    <figcaption>
        <h4>Breakpoint сработал. ClientContext не равен null</h4>
        
    </figcaption>
    
</figure>


<p>Цель достигнута. ngrok отлично подходит для отладки Remote Event Receivers списков и элементов, webhooks, httpsend action.
Так же можно использовать его для демонстрации работы add-in без развёртывания приложения на внешний хостинг.
Минусом является то, что в бесплатной версии ngrok-туннель живёт, пока не закрыто приложение ngrok.
В платной версии можно создавать постоянные адреса.</p>

    <hr />
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'biogenez';
    var disqus_identifier = 'http:\/\/ashblog.ru\/sp\/debug-remote-event-receivers\/';
    var disqus_title = 'SP Online: Debug Remote Event Receivers \x2b ngrok';
    var disqus_url = 'http:\/\/ashblog.ru\/sp\/debug-remote-event-receivers\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>    
</article>
        </div>
        <footer>
            <p>-</p>
        </footer>
        <script src="http://ashblog.ru/js/highlight-9.0.0.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        
        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-50925053-3']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        </script>
        
    </body>
</html>